<mat-card>
  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="form-container">
    <div class="row p-x-16 p-y-8">
      <h2 class="title p-x-16 p-y-8">ðŸ§¾ Nueva Factura</h2>
      <div class="btn-row d-flex justify-end gap-16 p-x-16 p-y-8">
        <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid">
          Guardar
        </button>
        <button
          mat-stroked-button
          color="warn"
          type="button"
          (click)="form.reset(); details.clear()"
        >
          Cancelar
        </button>
      </div>
    </div>

    <div class="row p-x-16 p-y-8">
      <!-- <mat-form-field appearance="fill" class="field">
        <mat-label>NÃºmero de Factura</mat-label>
        <input matInput formControlName="invoiceNumber" required />
      </mat-form-field> -->

      <mat-form-field appearance="fill" class="field">
        <mat-label>Cliente</mat-label>

        <mat-select formControlName="clientId" required>
          <mat-option *ngFor="let client of clients" [value]="client.clientId">
            {{ client.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" class="field">
        <mat-label>Fecha de emisiÃ³n</mat-label>
        <input matInput [matDatepicker]="pickerIssue" formControlName="issueDate" required />
        <mat-datepicker-toggle matSuffix [for]="pickerIssue"></mat-datepicker-toggle>
        <mat-datepicker #pickerIssue></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="fill" class="field">
        <mat-label>Fecha de vencimiento</mat-label>
        <input matInput [matDatepicker]="pickerDue" formControlName="dueDate" required />
        <mat-datepicker-toggle matSuffix [for]="pickerDue"></mat-datepicker-toggle>
        <mat-datepicker #pickerDue></mat-datepicker>
      </mat-form-field>

      <mat-error *ngIf="form.hasError('dueBeforeIssue')">
        La fecha de vencimiento no puede ser anterior a la fecha de emisiÃ³n.
      </mat-error>
    </div>
    <div class="payment-methods-wrapper">
      <div class="payment-methods">
        <button
          mat-raised-button
          [color]="selectedPaymentMethod === 'CrÃ©dito' ? 'primary' : 'accent'"
          [ngClass]="{ 'selected-method': selectedPaymentMethod === 'CrÃ©dito' }"
          (click)="selectPaymentMethod('CrÃ©dito')"
        >
          ðŸ’³ CrÃ©dito
        </button>
        <button
          mat-raised-button
          [color]="selectedPaymentMethod === 'Efectivo' ? 'primary' : 'accent'"
          [ngClass]="{ 'selected-method': selectedPaymentMethod === 'Efectivo' }"
          (click)="selectPaymentMethod('Efectivo')"
        >
          ðŸ’µ Efectivo
        </button>
        <button
          mat-raised-button
          [color]="selectedPaymentMethod === 'Mixto' ? 'primary' : 'accent'"
          [ngClass]="{ 'selected-method': selectedPaymentMethod === 'Mixto' }"
          (click)="selectPaymentMethod('Mixto')"
        >
          ðŸ’± Mixto
        </button>
        <button
          mat-raised-button
          [color]="selectedPaymentMethod === 'Tarjeta' ? 'primary' : 'accent'"
          [ngClass]="{ 'selected-method': selectedPaymentMethod === 'Tarjeta' }"
          (click)="selectPaymentMethod('Tarjeta')"
        >
          ðŸ’³ Tarjeta
        </button>
      </div>

      <div class="row p-x-16 p-y-8">
        <!-- NÃºmero de Factura -->
        <!-- <mat-form-field appearance="fill" class="field">
        <mat-label>NÃºmero de Factura</mat-label>
        <input matInput formControlName="invoiceNumber" required />
      </mat-form-field> -->

        <!-- MÃ©todo de pago -->
        <!-- <mat-form-field appearance="fill" class="field">
        <mat-label>MÃ©todo de Pago</mat-label>
        <input matInput [value]="selectedPaymentMethod" readonly />
      </mat-form-field> -->

        <!-- Total Factura (solo lectura) -->
        <mat-card class="total-display-card">
          <div class="total-label">Total</div>
          <div class="total-value">
            <span class="amount-icon">ðŸ’°</span>
            {{ form.get('totalAmount')?.value | currency: '' : 'symbol' }}
          </div>
        </mat-card>
      </div>
    </div>

    <h3 class="p-x-16 p-y-8">Detalles</h3>
    <div formArrayName="details" class="p-x-16 p-y-8">
      <mat-form-field appearance="fill" class="field">
        <mat-label>Buscar producto</mat-label>
        <input
          matInput
          type="text"
          [formControl]="searchControl"
          [matAutocomplete]="auto"
          autocomplete="off"
        />

        <mat-autocomplete
          #auto="matAutocomplete"
          (optionSelected)="onProductSelected($event.option.value)"
        >
          <!-- Mostrar nombre y productId de los productos filtrados -->
          <mat-option *ngFor="let item of filteredProducts" [value]="item.barCode">
            {{ item.barCode }} ({{ item.name }})
          </mat-option>

          <!-- Mensaje si no se encontraron productos -->
          <mat-option *ngIf="filteredProducts.length === 0" disabled>
            No se encontraron productos
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <!-- Tabla de productos seleccionados -->
      <table mat-table [dataSource]="filteredDetails" class="mat-elevation-z1 full-width-table">
        <ng-container matColumnDef="barCode">
          <th mat-header-cell *matHeaderCellDef>Codigo de barra</th>
          <td mat-cell *matCellDef="let detail">
            {{ detail.barCode }}
          </td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Producto</th>
          <td mat-cell *matCellDef="let detail">
            {{ detail.name }}
            <!-- Accede correctamente al valor de productSearch -->
          </td>
        </ng-container>

        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef>Cantidad</th>
          <td mat-cell *matCellDef="let detail">
            <input matInput type="number" (change)="updateQuantity($event)" />
          </td>
        </ng-container>

        <ng-container matColumnDef="unitPrice">
          <th mat-header-cell *matHeaderCellDef>Precio unitario</th>
          <td mat-cell *matCellDef="let detail">
            {{ detail.unitPrice | currency }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let detail; let i = index">
            <button mat-icon-button color="warn" (click)="removeDetail(i)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>
  </form>

  <!-- <h2 class="title p-x-16 p-y-8">Facturas Registradas</h2>
  <mat-divider></mat-divider>

  <table mat-table [dataSource]="invoices" class="mat-elevation-z1 full-width-table">
    <ng-container matColumnDef="invoiceNumber">
      <th mat-header-cell *matHeaderCellDef>NÃºmero</th>
      <td mat-cell *matCellDef="let invoice">{{ invoice.invoiceNumber }}</td>
    </ng-container>

    <ng-container matColumnDef="clientId">
      <th mat-header-cell *matHeaderCellDef>Cliente</th>
      <td mat-cell *matCellDef="let invoice">{{ invoice.clientId }}</td>
    </ng-container>

    <ng-container matColumnDef="issueDate">
      <th mat-header-cell *matHeaderCellDef>Fecha emisiÃ³n</th>
      <td mat-cell *matCellDef="let invoice">{{ invoice.issueDate | date }}</td>
    </ng-container>

    <ng-container matColumnDef="totalAmount">
      <th mat-header-cell *matHeaderCellDef>Total</th>
      <td mat-cell *matCellDef="let invoice">{{ invoice.totalAmount | currency }}</td>
    </ng-container>

    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef>Estado</th>
      <td mat-cell *matCellDef="let invoice">{{ invoice.status }}</td>
    </ng-container>

    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>Acciones</th>
      <td mat-cell *matCellDef="let invoice">
        <button mat-icon-button color="primary" (click)="editInvoice(invoice)">
          <mat-icon>edit</mat-icon>
        </button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  </table> -->
</mat-card>
