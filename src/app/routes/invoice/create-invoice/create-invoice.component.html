<mat-card>
  <form [formGroup]="form" class="form-container">
    <div class="form-layout">
      <!-- Columna izquierda -->
      <div class="form-main">
        <div class="row p-x-16 p-y-8">
          <h2 class="title p-x-16 p-y-8">ðŸ§¾ Nueva Factura</h2>
          <div class="btn-row d-flex justify-end gap-16 p-x-16 p-y-8">
            <button
              mat-raised-button
              color="primary"
              type="button"
              (click)="saveInvoice()"
              [disabled]="form.invalid"
            >
              Guardar
            </button>
            <button
              mat-stroked-button
              color="warn"
              type="button"
              (click)="form.reset(); details.clear()"
            >
              Cancelar
            </button>
          </div>
        </div>

        <div class="row p-x-16 p-y-8">
          <mat-form-field appearance="fill" class="field">
            <mat-label>Cliente</mat-label>
            <mat-select formControlName="clientId" required>
              <mat-option *ngFor="let client of clients" [value]="client.clientId">
                {{ client.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="fill" class="field">
            <mat-label>Fecha de emisiÃ³n</mat-label>
            <input matInput [matDatepicker]="pickerIssue" formControlName="issueDate" required />
            <mat-datepicker-toggle matSuffix [for]="pickerIssue"></mat-datepicker-toggle>
            <mat-datepicker #pickerIssue></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="fill" class="field">
            <mat-label>Fecha de vencimiento</mat-label>
            <input matInput [matDatepicker]="pickerDue" formControlName="dueDate" required />
            <mat-datepicker-toggle matSuffix [for]="pickerDue"></mat-datepicker-toggle>
            <mat-datepicker #pickerDue></mat-datepicker>
          </mat-form-field>

          <mat-error *ngIf="form.hasError('dueBeforeIssue')">
            La fecha de vencimiento no puede ser anterior a la fecha de emisiÃ³n.
          </mat-error>
        </div>
        <div formArrayName="details" class="p-x-16 p-y-8">
          <mat-form-field appearance="fill" class="field">
           <mat-icon matPrefix>search</mat-icon>

            <input
              matInput
              type="text"
              [formControl]="searchControl"
              [matAutocomplete]="auto"
              autocomplete="off"
              placeholder="Buscar producto..."
            />
            <mat-autocomplete
              #auto="matAutocomplete"
              (optionSelected)="onProductSelected($event.option.value)"
            >
              <mat-option *ngFor="let item of filteredProducts" [value]="item.barCode">
                {{ item.barCode }} ({{ item.name }})
              </mat-option>
              <mat-option *ngIf="filteredProducts.length === 0" disabled>
                No se encontraron productos
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>

          <div class="product-list">
            <div
              class="product-item"
              *ngFor="let item of details.controls; let i = index"
              [formGroupName]="i"
            >
              <div class="product-info">
                <strong>{{ item.value.name }}</strong>
                <small>Precio: ${{ item.value.unitPrice | number: '1.0-0' }}</small>
              </div>

              <div class="product-actions">
                <button mat-icon-button (click)="incrementQuantity(i, item.value)">
                  <mat-icon>add</mat-icon>
                </button>
                <span>{{ item.value.quantity }}</span>
                <button mat-icon-button (click)="decrementQuantity(i)">
                  <mat-icon>remove</mat-icon>
                </button>
                <strong class="product-total">
                  ${{ item.value.unitPrice * item.value.quantity | number: '1.0-0' }}
                </strong>
                <button mat-icon-button color="warn" (click)="removeDetail(i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Columna derecha: MÃ©todos de pago -->
      <div class="form-side">
        <div class="payment-methods-wrapper">
          <div class="payment-methods">
            <button
              mat-raised-button
              [color]="selectedPaymentMethod === 'CrÃ©dito' ? 'primary' : 'accent'"
              [ngClass]="{ 'selected-method': selectedPaymentMethod === 'CrÃ©dito' }"
              (click)="selectPaymentMethod('CrÃ©dito')"
            >
              ðŸ’³ CrÃ©dito
            </button>
            <button
              mat-raised-button
              [color]="selectedPaymentMethod === 'Efectivo' ? 'primary' : 'accent'"
              [ngClass]="{ 'selected-method': selectedPaymentMethod === 'Efectivo' }"
              (click)="selectPaymentMethod('Efectivo')"
            >
              ðŸ’µ Efectivo
            </button>
            <button
              mat-raised-button
              [color]="selectedPaymentMethod === 'Tranferencia' ? 'primary' : 'accent'"
              [ngClass]="{ 'selected-method': selectedPaymentMethod === 'Tranferencia' }"
              (click)="selectPaymentMethod('Tranferencia')"
            >
              ðŸ’± Tranferencia
            </button>
            <button
              mat-raised-button
              [color]="selectedPaymentMethod === 'Tarjeta' ? 'primary' : 'accent'"
              [ngClass]="{ 'selected-method': selectedPaymentMethod === 'Tarjeta' }"
              (click)="selectPaymentMethod('Tarjeta')"
            >
              ðŸ’³ Tarjeta
            </button>
          </div>

          <mat-card class="total-display-card">
            <div class="total-label">Total</div>
            <div class="total-value">
              <span class="amount-icon">ðŸ’°</span>
              ${{ form.get('totalAmount')?.value | number: '1.0-0' }}
            </div>
          </mat-card>
        </div>
      </div>
    </div>
  </form>
</mat-card>
